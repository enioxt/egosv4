#!/bin/bash
# .git/hooks/pre-commit
# VERSION: 1.0.0 - EGOSv4 Quality Gate

RED='\033[31m'; GREEN='\033[32m'; YELLOW='\033[33m'; BLUE='\033[34m'; NC='\033[0m'

echo -e "${BLUE}ğŸ›¡ï¸  GUARANI PRE-COMMIT GOVERNANCE${NC}"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

FAIL=false
WARN=false

# 1. Verificar arquivos Guarani essenciais
if [ -d "guarani" ] || [ -d ".guarani" ]; then
    GUARANI_DIR=$([ -d "guarani" ] && echo "guarani" || echo ".guarani")
    
    if [ ! -f "$GUARANI_DIR/IDENTITY.md" ]; then
        echo -e "${RED}âŒ ERRO: $GUARANI_DIR/IDENTITY.md nÃ£o encontrado!${NC}"
        FAIL=true
    fi
    
    if [ ! -f "$GUARANI_DIR/PREFERENCES.md" ]; then
        echo -e "${YELLOW}âš ï¸  AVISO: $GUARANI_DIR/PREFERENCES.md nÃ£o encontrado${NC}"
        WARN=true
    fi
else
    echo -e "${YELLOW}âš ï¸  Nenhum diretÃ³rio guarani/ ou .guarani/ encontrado${NC}"
    WARN=true
fi

# 2. Verificar mensagem de commit convencional
COMMIT_MSG=$(cat .git/COMMIT_EDITMSG 2>/dev/null || echo "")
if [ -n "$COMMIT_MSG" ]; then
    if ! echo "$COMMIT_MSG" | grep -qE "^(feat|fix|chore|docs|style|refactor|test|perf|ci|build|revert)(\(.+\))?:.*"; then
        echo -e "${YELLOW}âš ï¸  Mensagem nÃ£o segue formato convencional${NC}"
        echo "   Esperado: feat:/fix:/chore:/docs: ..."
        WARN=true
    fi
fi

# 3. Verificar se TASKS.md foi modificado (se commit grande)
FILES_COUNT=$(git diff --cached --name-only | wc -l)
TASKS_MODIFIED=$(git diff --cached --name-only | grep -c "TASKS.md" || echo 0)

if [ "$FILES_COUNT" -gt 5 ] && [ "$TASKS_MODIFIED" -eq 0 ]; then
    echo -e "${YELLOW}âš ï¸  Commit grande ($FILES_COUNT arquivos) sem atualizar TASKS.md${NC}"
    echo "   Considere atualizar o SSOT"
    WARN=true
fi

# 4. Verificar secrets (bÃ¡sico)
SECRETS=$(git diff --cached -p | grep -iE "(api_key|password|secret|token)\s*=\s*['\"][^'\"]{20,}" | grep -i -v "process.env" | head -3 || echo "")
if [ -n "$SECRETS" ]; then
    echo -e "${RED}âŒ PossÃ­veis secrets detectados:${NC}"
    echo "$SECRETS"
    FAIL=true
fi

# 5. Verificar arquivos muito grandes
LARGE_FILES=$(git diff --cached --name-only | xargs wc -l 2>/dev/null | awk '$1 > 500 && !/total/ {print $2 " (" $1 " linhas)"}')
if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}âš ï¸  Arquivos acima do limite (500 linhas):${NC}"
    echo "$LARGE_FILES"
    WARN=true
fi

# 6. Resultado
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
if [ "$FAIL" = true ]; then
    echo -e "${RED}ğŸ›‘ COMMIT BLOQUEADO - Corrija os erros acima${NC}"
    exit 1
elif [ "$WARN" = true ]; then
    echo -e "${YELLOW}âš ï¸  Avisos detectados (nÃ£o bloqueante)${NC}"
else
    echo -e "${GREEN}âœ… GUARANI: Todas as verificaÃ§Ãµes passaram${NC}"
fi

exit 0
